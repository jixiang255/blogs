# css深入理解系列之stacking context算法

## 疑问与目的
1. relative定位的元素，偏离原来的位置但却不影响其他元素的布局，这是为什么？
2. 为什么opacity、transform等属性不会引起重排？

## stacking context概念
官方定义[css2.1 z-index](https://www.w3.org/TR/CSS21/visuren.html#z-index),有以下原话
```
In CSS 2.1, each box has a position in three dimensions. In addition to their horizontal and vertical positions, boxes lie along a "z-axis" and are formatted one on top of the other. Z-axis positions are particularly relevant when boxes overlap visually. This section discusses how boxes may be positioned along the z-axis.

The order in which the rendering tree is painted onto the canvas is described in terms of stacking contexts. Stacking contexts can contain further stacking contexts. A stacking context is atomic from the point of view of its parent stacking context; boxes in other stacking contexts may not come between any of its boxes.

Each box belongs to one stacking context. Each positioned box in a given stacking context has an integer stack level, which is its position on the z-axis relative other stack levels within the same stacking context. Boxes with greater stack levels are always formatted in front of boxes with lower stack levels. Boxes may have negative stack levels. Boxes with the same stack level in a stacking context are stacked back-to-front according to document tree order.

The root element forms the root stacking context. Other stacking contexts are generated by any positioned element (including relatively positioned elements) having a computed value of 'z-index' other than 'auto'. Stacking contexts are not necessarily related to containing blocks. In future levels of CSS, other properties may introduce stacking contexts, for example 'opacity' [CSS3COLOR].

Within each stacking context, the following layers are painted in back-to-front order:
1. the background and borders of the element forming the stacking context.
2. the child stacking contexts with negative stack levels (most negative first).
3. the in-flow, non-inline-level, non-positioned descendants.
4. the non-positioned floats.
5. the in-flow, inline-level, non-positioned descendants, including inline tables and inline blocks.
6. the child stacking contexts with stack level 0 and the positioned descendants with stack level 0.
7. the child stacking contexts with positive stack levels (least positive first).

Within each stacking context, positioned elements with stack level 0 (in layer 6), non-positioned floats (layer 4), inline blocks (layer 5), and inline tables (layer 5), are painted as if those elements themselves generated new stacking contexts, except that their positioned descendants and any would-be child stacking contexts take part in the current stacking context.
```
上述大体意思是每个元素有三个维度，水平、竖直、‘z-axis’，而z-axis用来处理当元素叠加的问题。

### The stacking context算法
在该[文章](https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Positioning/Understanding_z_index/The_stacking_context),有以下原话：
```
· Root element of document (HTML).
· Element with a position value "absolute" or "relative" and z-index value other than "auto".
· Element with a position value "fixed" or "sticky" (sticky for all mobile browsers, but not older desktop).
· Element that is a child of a flex (flexbox) container, with z-index value other than "auto".
· Element with a opacity value less than 1 (See the specification for opacity).
· Element with a mix-blend-mode value other than "normal".
· Element with any of the following properties with value other than "none":
	· transform
	· filter
	· perspective
	· clip-path
	· mask / mask-image / mask-border
· Element with a isolation value "isolate".
· Element with a -webkit-overflow-scrolling value "touch".
· Element with a will-change value specifying any property that would create a stacking context on non-initial value (see this post).
```
上述描述了当元素的属性值为上述所列的属性时，该元素将产生The stacking context。
### The stacking context排列规则
```
In summary:
	· Stacking contexts can be contained in other stacking contexts, and together create a hierarchy of stacking contexts.
	· Each stacking context is completely independent from its siblings: only descendant elements are considered when stacking is processed.
	· Each stacking context is self-contained: after the element's contents are stacked, the whole element is considered in the stacking order of the parent stacking context.
```
上述大体意思是
	1. Stacking contexts可以包含其他的Stacking contexts
	2. 元素间的Stacking context各自独立，互不影响
	3. 元素里的子元素Stacking contexts按序大小排列
### The stacking context示例
![](images/understanding_zindex_04.png)
如上图所示，运用上述排列规则3，div#1、div#2、div#3按照数值大小叠放；运用规则1、2，div#3里的元素不会影响div#1、div#2；在运用规则3，div#4、div#5、div#6按照大小排列。

## 参考
+ https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Positioning/Understanding_z_index/The_stacking_context
+ https://www.w3.org/TR/CSS21/visuren.html#z-index
