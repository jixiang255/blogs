# css深入理解系列之渲染页面及盒子模型生成算法

## 疑问与目的

1. 浏览器如何处理用户定义的css样式？
2. css样式如何影响元素的展现？

## 浏览器处理css过程

在[css3 display](https://drafts.csswg.org/css-display/)中，有以下原话
```
CSS takes a source document, organized as a tree of elements and text nodes, and renders it onto a canvas (such as your screen, a piece of paper, or an audio stream). To do this, it generates an intermediary structure, the box tree, which represents the formatting structure of the rendered document. Each box in the box tree represents its corresponding element (or pseudo-element) in space and/or time on the canvas, while each text run in the box tree likewise represents the contents of its corresponding text nodes.

To create the box tree, CSS first uses cascading and inheritance, to assign a computed value for each CSS property to each element and text node in the source tree. (See [CSS3-CASCADE].)

Then, for each element, CSS generates zero or more boxes as specified by that element’s display property. Typically, an element generates a single box. However, some display values (e.g. display: list-item) generate more than one box (e.g. a principal block box and a marker box). And some values (such as none or contents) cause the element and/or its descendants to not generate any boxes at all. Boxes are assigned the same styles as their generating element, unless otherwise indicated. They’re often referred to by their display type—e.g. a box generated by an element with display: block is called a “block box” or just a “block”.

Similarly, each contiguous sequence of sibling text nodes generates a text run, which is assigned the same styles as the generating text nodes.

An anonymous box is is a box that is not associated with any element. Anonymous boxes are generated in certain circumstances to fix up the box tree when it requires a particular nested structure that is not provided by the boxes generated from the element tree. For example, a table cell box requires a particular type of parent box (the table row box), and will generate an anonymous table row box around itself if its parent is not a table row box. (See [CSS2] § 17.2.1.) Unlike element-generated boxes, whose styles inherit strictly through the element tree, anonymous boxes (which only exist in the box tree) inherit through their box tree parentage.

In the course of layout, boxes and text runs can be broken into multiple fragments. This happens, for example, when an inline box and/or text run is broken across lines, or when a block box is broken across pages or columns. A box therefore consists of one or more box fragments, and a text run consists of one or more text fragments. See [CSS3-BREAK] for more information on fragmentation.
```
上述大体上描述的是，页面渲染前构建box tree，box tree是网页元素的盒子模型集合。(在[《前端性能优化概括》]()中详细阐述了浏览器渲染页面的过程)接着，css将使用cascading and inheritance规则和样式默认值，为每个元素的盒子模型分配数值，具体决定盒子模型的类型是根据display属性值判断。若没有指定元素的display，则根据元素默认的显示类型(block、inline)；而盒子类型在css3前，主要有block、inline、table、positioned，而后新增了flexible box、grid、ruby、multi-column。

另外，需要注意的是`匿名box的生成(anonymous box)`，在[css2.1](https://www.w3.org/TR/CSS21/visuren.html)描述block、inline类型中均有涉及，该盒子的特点是样式不能被用户修改。

示例：
```
<div>你好<div>哈哈</div></div>
```
运用上述过程，将产生3个box，div元素的display类型，是block；`你好`文字产生匿名box。

**默认样式**

+ [Default Styles for Firefox](https://dxr.mozilla.org/mozilla-central/source/layout/style/res/html.css)
+ [Default Styles for Internet Explorer](http://web.archive.org/web/20170122223926/http://www.iecss.com/)
+ [Default Styles for Chrome / Webkit](http://trac.webkit.org/browser/trunk/Source/WebCore/css/html.css)
+ [Default Styles for Opera](http://web.archive.org/web/20161031005401/http://www.iecss.com/opera-10.51.css)
+ [Default Styles for HTML4 (W3C spec)](https://www.w3.org/TR/2011/REC-CSS2-20110607/sample.html#q22.0)
+ [Default Styles for HTML5 (W3C spec)](http://www.w3.org/TR/html5/rendering.html)

## 结论

基于上述的认识，可以回答《开篇》中的“ie浏览器下padding 3px”疑惑，是由于浏览器内置样式导致的；因此，由默认样式引出了`css reset`概念。盒子模型类型由display决定，那么具体类型将如何影响元素的呈现？


## 参考

+ https://stackoverflow.com/questions/6867254/browsers-default-css-for-html-elements
+ https://www.w3.org/TR/CSS21/visuren.html
+ https://puttaraju.wordpress.com/2012/07/04/rendering-a-simple-page-in-webkit-part1-2/